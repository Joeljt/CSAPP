## 按需分页

`malloc` 申请内存的过程体现了 Demand Paging（按需分页） 的机制。

### 🔹 什么是 Demand Paging？

按需分页（Demand Paging） 是一种懒加载（Lazy Loading） 的内存管理策略：
- 进程访问某个虚拟页（VP）时，如果该页不在主存（PP），就会触发 Page Fault。
- 操作系统才会在此时分配物理页，并将数据加载到主存。
- 如果是文件映射页，可能从磁盘加载；如果是匿名页（比如 `malloc` 申请的内存），则可能会分配一个全零的页。

### 🔹 `malloc` 体现了 Demand Paging 的哪些特性？

1. `malloc` 申请的是虚拟地址空间，而非物理内存  
   - 调用 `malloc(n bytes)` 只是向操作系统声明 需要 `n` 字节的空间。
   - 但不会立即分配物理页，页表中的 PTE 可能还是无效的。
   
2. 真正访问（读/写）该地址时，才触发 Page Fault，操作系统分配物理页  
   - `malloc` 申请的匿名页（Anonymous Page）在第一次写入时，触发 Page Fault。
   - 操作系统分配一个物理页，并在页表中建立 VP → PP 的映射。

3. 主存不足时，按需换出（Swap Out）  
   - 如果物理内存不足，OS 可能会将最近最少使用（LRU）的页面换出到 Swap，腾出空间给新的 `malloc` 申请的页面。
   - 这也是 Demand Paging 结合 Swap 实现内存扩展的方式。

### 🔹 为什么 `malloc` 不是直接分配物理页？
- 如果 `malloc` 直接分配物理页，可能会造成大量未使用的页浪费主存。
- 按需分页优化了内存使用，只有真正需要的页才会被分配物理页，减少不必要的内存开销。

总结：

`malloc` 体现了 Demand Paging，因为它只申请虚拟地址空间，在进程第一次访问时才会触发 Page Fault，按需分配物理页，从而优化内存使用效率。 