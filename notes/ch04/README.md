# 处理器体系结构

## 1. Y86-64 指令集架构

### 1.1 程序员可见状态
- 15 个通用寄存器（%rax 到 %r14）
- PC：程序计数器
- 条件码：ZF、SF、OF
- 状态码：Stat（AOK、HLT、ADR、INS）

### 1.2 指令格式
- 每条指令 1-10 字节
- 第一个字节包含：
  - 高 4 位：指令代码（icode）
  - 低 4 位：功能码（ifun）

### 1.3 主要指令类型
```
halt          停止执行
nop           无操作
rrmovq        寄存器移动
irmovq        立即数移动
rmmovq        寄存器到内存
mrmovq        内存到寄存器
addq/subq     整数运算
jmp/jle/jl    条件跳转
call/ret      函数调用/返回
pushq/popq    栈操作
```

## 2. 顺序实现

### 2.1 SEQ 处理器
- 按照严格顺序执行指令
- 每条指令经过 6 个阶段：
  1. 取指（Fetch）
  2. 译码（Decode）
  3. 执行（Execute）
  4. 访存（Memory）
  5. 写回（Write Back）
  6. 更新 PC（PC Update）

### 2.2 硬件结构
- 组合逻辑：无状态
- 时钟寄存器：存储状态
- 内存：读写数据
- 寄存器堆：读写寄存器

## 3. 流水线实现

### 3.1 PIPE 处理器
- 同时处理多条指令
- 每个时钟周期完成一条指令
- 理想情况：吞吐量提高 5 倍

### 3.2 流水线冒险
1. 数据冒险
   - 数据依赖导致的停顿
   - 解决：数据转发

2. 控制冒险
   - 分支指令导致的停顿
   - 解决：分支预测

3. 结构冒险
   - 硬件资源冲突
   - 解决：资源复制或流水线停顿

### 3.3 性能分析
- 吞吐量：CPI（每指令周期数）
- 延迟：完成一条指令所需周期
- 影响因素：
  - 数据依赖
  - 分支预测准确率
  - 内存访问延迟

## 4. 现代处理器优化

### 4.1 指令级并行
- 超标量：每周期执行多条指令
- 乱序执行：打破顺序限制
- 寄存器重命名：消除假依赖

### 4.2 预测技术
- 分支预测：预测跳转方向
- 内存预测：预测内存依赖
- 值预测：预测计算结果

### 4.3 存储系统优化
- 多级缓存
- 预取机制
- 写缓冲

## 5. 编程优化建议

1. 减少数据依赖
   - 重排指令顺序
   - 使用临时变量

2. 提高并行度
   - 循环展开
   - 多线程并行

3. 优化内存访问
   - 合理使用缓存
   - 减少内存访问次数
