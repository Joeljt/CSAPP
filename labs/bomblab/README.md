## Solution

bomblab æä¾›äº†ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ bombï¼Œæ‰§è¡Œåæç¤ºè¾“å…¥å†…å®¹ï¼Œå¦‚æœè¾“å‡ºé”™è¯¯ç¨‹åºå°±ä¼šçˆ†ç‚¸ã€‚

éœ€è¦åˆ©ç”¨ gdb è¿›è¡Œ debugï¼Œåç¼–è¯‘ç ´è§£äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé€šè¿‡æŸ¥çœ‹æ±‡ç¼–æŒ‡ä»¤è¿˜åŸç¨‹åºé€»è¾‘ï¼Œç¡®å®šéœ€è¦è¾“å…¥çš„å†…å®¹æ˜¯ä»€ä¹ˆã€‚

ç¨‹åºä¸€å…±æœ‰ 6 ä¸ªé˜¶æ®µï¼Œéš¾åº¦ç³»æ•°æŒ‰é˜¶æ®µå¢åŠ ï¼›åŒæ—¶ï¼Œè¿˜æœ‰ä¸€ä¸ªéšè—çš„é˜¶æ®µï¼Œéœ€è¦é€šè¿‡ç‰¹æ®Šæ–¹å¼è¿›å…¥ã€‚

### ç¬¬ä¸€é˜¶æ®µ

æ‰§è¡Œ bomb ç¨‹åºåè®¾ç½®æ–­ç‚¹ `b phase_1`ï¼Œåç¼–è¯‘è¯¥æ–¹æ³•å¦‚ä¸‹ï¼š

```assemby
(gdb) disas phase_1
Dump of assembler code for function phase_1:
   0x0000000000400ee0 <+0>:	sub    $0x8,%rsp
   0x0000000000400ee4 <+4>:	mov    $0x402400,%esi
   0x0000000000400ee9 <+9>:	callq  0x401338 <strings_not_equal>
   0x0000000000400eee <+14>:	test   %eax,%eax
   0x0000000000400ef0 <+16>:	je     0x400ef7 <phase_1+23>
   0x0000000000400ef2 <+18>:	callq  0x40143a <explode_bomb>
   0x0000000000400ef7 <+23>:	add    $0x8,%rsp
   0x0000000000400efb <+27>:	retq   
End of assembler dump.
```

é€šè¿‡åˆ†æä»£ç å¯ä»¥å‘ç°ï¼š

1. æ ˆæŒ‡é’ˆå‘ä¸‹ç§»åŠ¨ï¼Œå¼€è¾Ÿäº† 8 å­—èŠ‚ç©ºé—´ï¼›
2. æ›´æ–°å¯„å­˜å™¨ `%esi` çš„å€¼ä¸º `0x402400`ï¼Œè¿™æ˜¯ä¸€ä¸ªå†…å­˜åœ°å€å€¼ï¼›
3. ä¹‹åè°ƒç”¨ `strings_not_equal` æ–¹æ³•åï¼Œç”¨ test æŒ‡ä»¤æ£€æŸ¥ä¸€è‡´æ€§ï¼›
4. å¦‚æœå€¼ç›¸åŒå°±å›æ”¶æ ˆç©ºé—´åè¿”å›ï¼Œå¦åˆ™çˆ†ç‚¸ç»“æŸã€‚

é‚£é—®é¢˜å°±å¾ˆæ¸…æ™°äº†ï¼Œåªéœ€è¦ç¡®è®¤åœ°å€ `0x402400` å­˜å‚¨çš„å†…å®¹æ˜¯ä»€ä¹ˆå³å¯ï¼š

```assembly
(gdb) x/s 0x402400
0x402400:	"Border relations with Canada have never been better."
```

ç¬¬ä¸€ä¸ªç‚¸å¼¹æ‹†é™¤å®Œæˆã€‚ğŸ‰

### ç¬¬äºŒé˜¶æ®µ

ç»§ç»­ä¸‹ä¸€ä¸ªï¼Œæ–­ç‚¹åˆ° `b phase_2` ååç¼–è¯‘ï¼Œä¼šå‘ç°æ–¹æ³•å†…éƒ¨ä¼šå…ˆè°ƒç”¨ä¸€ä¸ª `read_six_numbers` æ–¹æ³•ï¼š

```assembly
0x0000000000400f05 <+9>:	callq  0x40145c <read_six_numbers>
```
æ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘ï¼š

```assembly
(gdb) disas read_six_numbers
Dump of assembler code for function read_six_numbers:
   0x000000000040145c <+0>:	sub    $0x18,%rsp
   0x0000000000401460 <+4>:	mov    %rsi,%rdx
   0x0000000000401463 <+7>:	lea    0x4(%rsi),%rcx
   0x0000000000401467 <+11>:	lea    0x14(%rsi),%rax
   0x000000000040146b <+15>:	mov    %rax,0x8(%rsp)
   0x0000000000401470 <+20>:	lea    0x10(%rsi),%rax
   0x0000000000401474 <+24>:	mov    %rax,(%rsp)
   0x0000000000401478 <+28>:	lea    0xc(%rsi),%r9
   0x000000000040147c <+32>:	lea    0x8(%rsi),%r8
   0x0000000000401480 <+36>:	mov    $0x4025c3,%esi
   0x0000000000401485 <+41>:	mov    $0x0,%eax
   0x000000000040148a <+46>:	callq  0x400bf0 <__isoc99_sscanf@plt>
   0x000000000040148f <+51>:	cmp    $0x5,%eax
   0x0000000000401492 <+54>:	jg     0x401499 <read_six_numbers+61>
   0x0000000000401494 <+56>:	callq  0x40143a <explode_bomb>
   0x0000000000401499 <+61>:	add    $0x18,%rsp
   0x000000000040149d <+65>:	retq   
End of assembler dump.
```

å¯ä»¥å‘ç°æ˜¯å¯¹å¯„å­˜å™¨åšäº†ä¸€å †æ“ä½œåï¼Œè°ƒç”¨äº† C æ ‡å‡†åº“çš„ sscanf å‡½æ•°ï¼Œç„¶åæ ¹æ®è¿”å›å€¼æ˜¯å¦å¤§äº 5 å†³å®šæ˜¯å¦å¼•çˆ†ç‚¸å¼¹ã€‚

å…¶ä¸­ï¼Œsscanf å‡½æ•°çš„ä½œç”¨æ˜¯æ¥æ”¶å¯å˜é•¿åº¦çš„å‚æ•°ï¼ŒæŒ‰ç»™å®šæ ¼å¼ä»è¾“å…¥å­—ç¬¦ä¸²ä¸­æå–å†…å®¹ï¼Œè¿”å›å€¼æ˜¯åŒ¹é…ä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚

å¾ˆæ˜æ˜¾ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å’Œå‡½æ•°åä¸€æ ·çš„æ•ˆæœï¼Œç”¨æ¥å¼ºåˆ¶è¦æ±‚è¾“å…¥çš„å†…å®¹æ˜¯ 6 ä¸ªæ•°å­—ï¼š

1. ç¬¬ä¸€ä¸ªå‚æ•°åœ¨å¯„å­˜å™¨ `%rdi` ä¸­ï¼Œè¡¨ç¤ºè¾“å…¥çš„å†…å®¹ï¼›
2. ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ ¼å¼åŒ–è§„æ ¼ï¼Œå‚¨å­˜åœ¨å¯„å­˜å™¨ `%rsi` é‡Œï¼Œä¹Ÿå°±æ˜¯ <+36> çš„æ“ä½œï¼Œæ£€æŸ¥åå‘ç°æ ¼å¼æ˜¯ `%d %d %d %d %d %d`ï¼Œæ„å‘³ç€æˆ‘ä»¬éœ€è¦æŒ‰ç…§è¿™ä¸ªæ ¼å¼è¾“å…¥ 6 ä¸ªæ•´æ•°;
3. å‰©ä¸‹çš„ 6 ä¸ªå‚æ•°ï¼Œå‰ 4 ä¸ªåœ¨å¯„å­˜å™¨ `%rax`ã€`%rdx`ã€`%r8`ã€`%r9` é‡Œï¼Œåä¸¤ä¸ªåœ¨æ ˆä¸Šï¼Œå°±æ˜¯æ“ä½œ `%rsp` çš„ä¸¤æ¬¡ï¼›

å¦‚æœæ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œå°±èƒ½é€šè¿‡è¿™ä¸ªå‡½æ•°çš„æ ¼å¼æ ¡éªŒï¼Œæ­£å¸¸è¿”å› `phase_2` ç»§ç»­æ‰§è¡Œã€‚

```assembly
(gdb) disas phase_2
Dump of assembler code for function phase_2:
=> 0x0000000000400efc <+0>:	push   %rbp                             
   0x0000000000400efd <+1>:	push   %rbx
   0x0000000000400efe <+2>:	sub    $0x28,%rsp                       ; 1. åˆ†é… 40 bytesï¼š2 ä¸ªå¯„å­˜å™¨æŒ‡é’ˆ + 6 ä¸ª int
   0x0000000000400f02 <+6>:	mov    %rsp,%rsi                        ; 2. å°†æ ˆæŒ‡é’ˆï¼ˆæ ˆé¡¶å…ƒç´ ï¼‰ä»¥ç¬¬äºŒä¸ªå‚æ•°ä¼ ç»™ read_six_numbers 
   0x0000000000400f05 <+9>:	callq  0x40145c <read_six_numbers>      ; 3. è°ƒç”¨ read_six_numbers è·å– 6 ä¸ªæ•°å­—
   0x0000000000400f0a <+14>:	cmpl   $0x1,(%rsp)                  ; 4. åˆ¤æ–­æ ˆé¡¶å…ƒç´ æ˜¯å¦ä¸º 1
   0x0000000000400f0e <+18>:	je     0x400f30 <phase_2+52>        ; 5. å¦‚æœæ ˆé¡¶å…ƒç´ æ˜¯ 1ï¼Œæ‰§è¡Œ <+52>
   0x0000000000400f10 <+20>:	callq  0x40143a <explode_bomb>
   0x0000000000400f15 <+25>:	jmp    0x400f30 <phase_2+52>
   0x0000000000400f17 <+27>:	mov    -0x4(%rbx),%eax              ; 9. %rbx - 4 æŒ‡å‘å½“å‰ %rbx çš„å‰ä¸€ä¸ªå…ƒç´ ï¼Œèµ‹å€¼ç»™ %rax
   0x0000000000400f1a <+30>:	add    %eax,%eax                    ; 10. æ›´æ–° %rax = 2 * %rax
   0x0000000000400f1c <+32>:	cmp    %eax,(%rbx)                  ; 11. åˆ¤æ–­ %rbx æ˜¯å¦æ˜¯å®ƒå‰ä¸€ä¸ªå…ƒç´ çš„ 2 å€
   0x0000000000400f1e <+34>:	je     0x400f25 <phase_2+41>        ; 12. å¦‚æœå½“å‰ä½ç½®çš„å…ƒç´ æ˜¯å‰ä¸€ä¸ªå…ƒç´ çš„ 2 å€ï¼Œåˆ™ç»§ç»­æ‰§è¡Œ <+41>
   0x0000000000400f20 <+36>:	callq  0x40143a <explode_bomb>
   0x0000000000400f25 <+41>:	add    $0x4,%rbx                    ; 13. %rbx + 4ï¼Œå‘ä¸Šç§»åŠ¨åˆ°ä¸Šä¸€ä¸ªæ•°å­—ï¼Œå³ä¸‹ä¸€ä¸ªæ•°å­—
   0x0000000000400f29 <+45>:	cmp    %rbp,%rbx                    ; 14. å’Œç¬¬ 6 ä¸ªæ•°åšæ¯”è¾ƒ
   0x0000000000400f2c <+48>:	jne    0x400f17 <phase_2+27>        ; 15. å¦‚æœå½“å‰ä¸æ˜¯ç¬¬ 6 ä¸ªæ•°ï¼Œå›åˆ° <+27>ï¼Œå³ç¬¬ 9 æ­¥ï¼Œå¾ªç¯
   0x0000000000400f2e <+50>:	jmp    0x400f3c <phase_2+64>        ; 16. 6 ä¸ªæ•°å­—éƒ½æ»¡è¶³ä» 1 å¼€å§‹ 2 å€é€’å¢ï¼Œè·³å‡ºå¾ªç¯ï¼Œæ‰§è¡Œ <+64>
   0x0000000000400f30 <+52>:	lea    0x4(%rsp),%rbx               ; 6. å–å‡º %rsp + 4ï¼Œèµ‹å€¼ç»™ %rbxï¼Œç¬¬äºŒä¸ªå‚æ•° 2nd
   0x0000000000400f35 <+57>:	lea    0x18(%rsp),%rbp              ; 7. å–å‡º %rsp + 24ï¼Œè¿™é‡Œæ˜¯å®šä½åˆ°äº†ç¬¬å…­ä¸ªæ•°å­—æ‰€åœ¨çš„åœ°å€
   0x0000000000400f3a <+62>:	jmp    0x400f17 <phase_2+27>        ; 8. æ‰§è¡Œ <+27>
   0x0000000000400f3c <+64>:	add    $0x28,%rsp                   ; 17. å›æ”¶å¼€è¾Ÿçš„å†…å­˜
   0x0000000000400f40 <+68>:	pop    %rbx
   0x0000000000400f41 <+69>:	pop    %rbp
   0x0000000000400f42 <+70>:	retq                                ; 18. ç»“æŸ
End of assembler dump.
```

åˆ†ææ±‡ç¼–ä»£ç å¯çŸ¥ï¼Œæˆ‘ä»¬éœ€è¦è¾“å…¥çš„æ˜¯ä¸€ä¸ªä» 1 å¼€å§‹ï¼Œå…¬æ¯”ä¸º 2 çš„ç­‰æ¯”æ•°åˆ—ï¼Œä¸€å…± 6 ä¸ªæ•°å­—ï¼Œæ¯ä¸ªæ•°å­—ä¹‹é—´ä»¥ç©ºæ ¼åˆ†éš”ï¼Œå³ï¼š`1 2 4 8 16 32`ã€‚

ç¬¬äºŒä¸ªç‚¸å¼¹æ‹†é™¤å®Œæˆã€‚ğŸ‰

### ç¬¬ä¸‰é˜¶æ®µ

æˆ‘ä»¬ç»§ç»­çœ‹ç¬¬ä¸‰é˜¶æ®µï¼Œåæ±‡ç¼–å¦‚ä¸‹ï¼š

```assembly
(gdb) disas phase_3
Dump of assembler code for function phase_3:
=> 0x0000000000400f43 <+0>:	sub    $0x18,%rsp
   0x0000000000400f47 <+4>:	lea    0xc(%rsp),%rcx                           ; è¾“å…¥çš„å€¼å­˜åœ¨ $rsp+4 å’Œ $rsp+12 ä¸¤ä¸ªä½ç½®
   0x0000000000400f4c <+9>:	lea    0x8(%rsp),%rdx
   0x0000000000400f51 <+14>:	mov    $0x4025cf,%esi                       ; "%d %d"ï¼Œè¦æ±‚è¾“å…¥ä¸¤ä¸ªæ•´æ•°
   0x0000000000400f56 <+19>:	mov    $0x0,%eax
   0x0000000000400f5b <+24>:	callq  0x400bf0 <__isoc99_sscanf@plt>       ; åˆ©ç”¨ sscanf ä»å­—ç¬¦ä¸²ä¸­å–å€¼
   0x0000000000400f60 <+29>:	cmp    $0x1,%eax
   0x0000000000400f63 <+32>:	jg     0x400f6a <phase_3+39>
   0x0000000000400f65 <+34>:	callq  0x40143a <explode_bomb>
   0x0000000000400f6a <+39>:	cmpl   $0x7,0x8(%rsp)                       ; ç”¨ 7 å’Œç¬¬ä¸€ä¸ªå€¼åšå¯¹æ¯”     
   0x0000000000400f6f <+44>:	ja     0x400fad <phase_3+106>               ; æ³¨æ„ ja æ— ç¬¦å·æ¯”è¾ƒï¼Œç¬¬ä¸€ä¸ªå€¼å¯é€‰èŒƒå›´ [0, 7]
   0x0000000000400f71 <+46>:	mov    0x8(%rsp),%eax                       
   0x0000000000400f75 <+50>:	jmpq   *0x402470(,%rax,8)                   ; åœ¨ 0x402470 åŸºç¡€ä¸Šåš [0, 7]*8 çš„åç§»åæ‰§è¡Œè·³è½¬
   0x0000000000400f7c <+57>:	mov    $0xcf,%eax                           
   0x0000000000400f81 <+62>:	jmp    0x400fbe <phase_3+123>
   0x0000000000400f83 <+64>:	mov    $0x2c3,%eax
   0x0000000000400f88 <+69>:	jmp    0x400fbe <phase_3+123>
   0x0000000000400f8a <+71>:	mov    $0x100,%eax
   0x0000000000400f8f <+76>:	jmp    0x400fbe <phase_3+123>
   0x0000000000400f91 <+78>:	mov    $0x185,%eax
   0x0000000000400f96 <+83>:	jmp    0x400fbe <phase_3+123>
   0x0000000000400f98 <+85>:	mov    $0xce,%eax
   0x0000000000400f9d <+90>:	jmp    0x400fbe <phase_3+123>
   0x0000000000400f9f <+92>:	mov    $0x2aa,%eax
   0x0000000000400fa4 <+97>:	jmp    0x400fbe <phase_3+123>
   0x0000000000400fa6 <+99>:	mov    $0x147,%eax
   0x0000000000400fab <+104>:	jmp    0x400fbe <phase_3+123>
   0x0000000000400fad <+106>:	callq  0x40143a <explode_bomb>
   0x0000000000400fb2 <+111>:	mov    $0x0,%eax
   0x0000000000400fb7 <+116>:	jmp    0x400fbe <phase_3+123>
   0x0000000000400fb9 <+118>:	mov    $0x137,%eax
   0x0000000000400fbe <+123>:	cmp    0xc(%rsp),%eax
   0x0000000000400fc2 <+127>:	je     0x400fc9 <phase_3+134>
   0x0000000000400fc4 <+129>:	callq  0x40143a <explode_bomb>
   0x0000000000400fc9 <+134>:	add    $0x18,%rsp
   0x0000000000400fcd <+138>:	retq   
End of assembler dump.
```

ç¬¬ä¸‰é˜¶æ®µçš„ä»£ç æ˜¯ switch-case çš„è·³è½¬è¡¨ä¼˜åŒ–ï¼Œä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼š

1. åªèƒ½è¾“å…¥ä¸¤ä¸ªæ•´æ•° `x` å’Œ `y`ï¼ŒæŒ‰ç©ºæ ¼åˆ†éš”ï¼›
2. é™åˆ¶ `x` åªèƒ½æ˜¯ [0, 7] ä¹‹é—´çš„æŸä¸ªæ•°å­—ï¼›
3. æ ¹æ® `x` çš„å€¼è¿›è¡Œé—´æ¥è·³è½¬çš„åœ°å€å€¼è®¡ç®—ï¼Œè®¡ç®—è§„åˆ™æ˜¯ï¼š`0x402470 + x * 8`ï¼Œå¯ä»¥è®¡ç®—å‡ºæ¥ 8 ä¸ªåœ°å€ï¼›
4. å¯ä»¥å‘ç°æœ‰å¾ˆå¤š `je 0x400fc9 <phase_3+134>` æ¡ä»¶è·³è½¬ï¼Œå¯¹åº”çš„æ­£æ˜¯ä¸Šé¢çš„ 8 ä¸ªåœ°å€ï¼›
5. æ‰€ä»¥åªéœ€è¦æŒ‰ç…§è·³è½¬åˆ°çš„åœ°å€ï¼Œç¡®å®š `x` çš„å€¼å¯¹åº”çš„ `y` æ˜¯å“ªä¸ªå€¼å³å¯ï¼›

ç¬¬ä¸‰é˜¶æ®µçš„é‡ç‚¹åœ¨äºè·³è½¬è¡¨çš„ç†è§£ã€‚

åœ¨ switch è¯­å¥çš„ case å€¼ç›¸å¯¹è¿ç»­æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæŠŠ case è¯­å¥å—å•ç‹¬å°è£…åˆ°ä¸€ä¸ªä»£ç å—é‡Œã€‚

ä¹‹åå°†æ‰€æœ‰çš„ case è¯­å¥å—éƒ½æ”¾åˆ°ä¸€ä¸ªæ•°ç»„é‡Œï¼Œåœ¨åŒ¹é…çš„æ—¶å€™ï¼Œç›´æ¥ç”¨ case å€¼åšæ•°ç»„ç´¢å¼•ï¼Œä»¥ O(1) çš„æ•ˆç‡ç¡®å®šè·³è½¬åˆ°çš„è¯­å¥å—åœ°å€ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªè·³è½¬è¡¨æ•°ç»„æ˜¯ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œé‡Œé¢å­˜æ”¾çš„æ˜¯æŒ‡å‘å„ä¸ª case ä»£ç å—çš„èµ·å§‹ä½ç½®çš„æŒ‡é’ˆï¼Œå³è¯¥èµ·å§‹ä½ç½®çš„åœ°å€å€¼ï¼Œç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š

```c
[ 0x0003423234, 0x0003423873, 0x0003423256, 0x0003423852, ... ]
```

è€Œæ±‡ç¼–ä»£ç ä¸­é—´æ¥è·³è½¬æ—¶å€™çš„ `0x402470` å°±æ˜¯è¿™ä¸ªè·³è½¬è¡¨ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ æ‰€åœ¨çš„åœ°å€å€¼ï¼Œåé¢ 8 ä¸ªå­—èŠ‚çš„åç§»å°±æ˜¯åœ¨åç§»æ•°ç»„å…ƒç´ ã€‚

ç”±äº C è¯­è¨€ä¸­æ•°ç»„å®é™…ä¸Šå°±æ˜¯æŒ‡å‘ç¬¬ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆï¼Œè¿™ä¸ªè·³è½¬è¡¨çš„å£°æ˜å¤§æ¦‚å°±æ˜¯ï¼š`int* *table`ï¼Œè¡¨æ˜è¿™æ˜¯ä¸ªæ•°ç»„ï¼Œé‡Œé¢å­˜çš„å…ƒç´ éƒ½æ˜¯åœ°å€å€¼ã€‚

è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆåç§»é‡æ˜¯ 8 ä¸ªå­—èŠ‚ï¼Œå› ä¸ºæŒ‡é’ˆç±»å‹éœ€è¦ç”¨ 8 ä¸ªå­—èŠ‚å­˜å‚¨ã€‚

å¦å¤–è¿˜éœ€è¦å›é¡¾çš„ä¸€ç‚¹æ˜¯ï¼Œå°½ç®¡ `(%rax, rbx, 5)` ç»å¸¸è¢«ç”¨æ¥åšç®—æœ¯è¿ç®—ï¼Œä½†æ˜¯è¿™ä¸ªæœ€åŸå§‹çš„è¯­ä¹‰å®é™…ä¸Šæ˜¯ç´¢å¼•åç§»å¯»å€ï¼Œæœ€å¼€å§‹å°±æ˜¯ä¸ºæ•°ç»„ç´¢å¼•å…ƒç´ è®¾è®¡çš„å¯»å€æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬é‡åˆ°çš„è¿™ç§åœºæ™¯ã€‚

ç»¼ä¸Šï¼Œè¿™é“é¢˜ç›®æœ‰ 8 ç»„å¯èƒ½çš„ç­”æ¡ˆï¼Œæ¯”å¦‚ï¼š`0 207`ã€`1 707` ç­‰ã€‚

ç¬¬ä¸‰ä¸ªç‚¸å¼¹æ‹†é™¤å®Œæˆã€‚ğŸ‰

### ç¬¬å››é˜¶æ®µ

è¯ä¸å¤šè¯´ï¼Œçœ‹ä»£ç ï¼š

```assembly
(gdb) disas phase_4
Dump of assembler code for function phase_4:
=> 0x000000000040100c <+0>:	sub    $0x18,%rsp
   0x0000000000401010 <+4>:	lea    0xc(%rsp),%rcx
   0x0000000000401015 <+9>:	lea    0x8(%rsp),%rdx
   0x000000000040101a <+14>:	mov    $0x4025cf,%esi
   0x000000000040101f <+19>:	mov    $0x0,%eax
   0x0000000000401024 <+24>:	callq  0x400bf0 <__isoc99_sscanf@plt>
   0x0000000000401029 <+29>:	cmp    $0x2,%eax                        
   0x000000000040102c <+32>:	jne    0x401035 <phase_4+41>            ; "%d %d"ï¼Œé™åˆ¶æ˜¯ä¸¤ä¸ªæ•´æ•°
   0x000000000040102e <+34>:	cmpl   $0xe,0x8(%rsp)                   
   0x0000000000401033 <+39>:	jbe    0x40103a <phase_4+46>            ; æ— ç¬¦å·æ¯”è¾ƒï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦åœ¨ [0, 14]
   0x0000000000401035 <+41>:	callq  0x40143a <explode_bomb>
   0x000000000040103a <+46>:	mov    $0xe,%edx                        ; edx = 14ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°
   0x000000000040103f <+51>:	mov    $0x0,%esi                        ; esi = 0ï¼Œç¬¬äºŒä¸ªå‚æ•°
   0x0000000000401044 <+56>:	mov    0x8(%rsp),%edi                   ; ç¬¬ä¸€ä¸ªè¾“å…¥æ”¾åˆ° ediï¼Œç¬¬ä¸€ä¸ªå‚æ•°
   0x0000000000401048 <+60>:	callq  0x400fce <func4>                 ; ç”¨ä¸Šé¢ä¸‰ä¸ªå€¼è°ƒç”¨ func4(x, 0, 14)
   0x000000000040104d <+65>:	test   %eax,%eax                        ; test ä¼šæ›´æ”¹ ZF æ ‡è®°ï¼Œ%eax = 0 æ—¶ï¼ŒZF = 1
   0x000000000040104f <+67>:	jne    0x401058 <phase_4+76>            ; jne æˆç«‹çš„æ¡ä»¶æ˜¯ ZF ä¸ç­‰äº 0ï¼Œå³ %eax = 0
   0x0000000000401051 <+69>:	cmpl   $0x0,0xc(%rsp)                   ; åˆ¤æ–­ç¬¬äºŒä¸ªè¾“å…¥æ˜¯å¦ä¸º 0
   0x0000000000401056 <+74>:	je     0x40105d <phase_4+81>            ; ç­‰äº 0 å°±ç»“æŸï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªå€¼ä¸€å®šæ˜¯ 0
   0x0000000000401058 <+76>:	callq  0x40143a <explode_bomb>
   0x000000000040105d <+81>:	add    $0x18,%rsp
   0x0000000000401061 <+85>:	retq   
End of assembler dump.
```

æ ¹æ®ä¸Šé¢çš„ä»£ç å¯çŸ¥ï¼š

1. ç¬¬ä¸€ä¸ªå€¼éœ€è¦åœ¨ [0, 14] ä¹‹é—´ï¼Œç„¶åå’Œ 0ã€14 ä¸€èµ·ä¼ å…¥ `func4` é‡Œï¼Œä¿è¯ `func4` çš„è¿”å›å€¼ç­‰äº 0ã€‚
2. ç¬¬äºŒä¸ªå‚æ•°å¿…é¡»æ˜¯ 0ï¼›

æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­çœ‹ `func4` çš„å®ç°ï¼š

```
(gdb) disas func4
Dump of assembler code for function func4:
   0x0000000000400fce <+0>:	sub    $0x8,%rsp
   0x0000000000400fd2 <+4>:	mov    %edx,%eax                      
   0x0000000000400fd4 <+6>:	sub    %esi,%eax                      ; int m = end - start
   0x0000000000400fd6 <+8>:	mov    %eax,%ecx                      ; 
   0x0000000000400fd8 <+10>:	shr    $0x1f,%ecx                 ; int n = m >> 31 (m çš„ç¬¦å·ä½ 0 / 1)
   0x0000000000400fdb <+13>:	add    %ecx,%eax                  ; 
   0x0000000000400fdd <+15>:	sar    %eax                       ; 
   0x0000000000400fdf <+17>:	lea    (%rax,%rsi,1),%ecx         ; int res = (m + n) >>> 1 + func4 ç¬¬äºŒä¸ªå‚æ•°
                                                                  ; æ³¨æ„åˆ°è¿™é‡Œå®é™…ä¸Šå°±æ˜¯å¯¹ func4 çš„ç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªå‚æ•°åšäº†ä¸€äº›å¤„ç†ï¼Œå¾—åˆ°äº†ä¸€ä¸ªç»“æœ

   0x0000000000400fe2 <+20>:	cmp    %edi,%ecx                  ; 
   0x0000000000400fe4 <+22>:	jle    0x400ff2 <func4+36>        ; if res < ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ‰§è¡Œ +36
   0x0000000000400fe6 <+24>:	lea    -0x1(%rcx),%edx            ; 
   0x0000000000400fe9 <+27>:	callq  0x400fce <func4>           ; å¦‚æœ res >= ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œé€’å½’è°ƒç”¨ func4(x, start, --res)
   0x0000000000400fee <+32>:	add    %eax,%eax                  ; åœ¨ä¸Šé¢çš„é€’å½’è°ƒç”¨è¿”å›åæ‰§è¡Œï¼Œæ“ä½œä¸Šé¢è¿™æ¬¡è°ƒç”¨çš„è¿”å›å€¼åå†è¿”å›ç»™ä¸Šå±‚
   0x0000000000400ff0 <+34>:	jmp    0x401007 <func4+57>        
   0x0000000000400ff2 <+36>:	mov    $0x0,%eax                  ; int res = 0;
   0x0000000000400ff7 <+41>:	cmp    %edi,%ecx                  ; 
   0x0000000000400ff9 <+43>:	jge    0x401007 <func4+57>        ; å¯èƒ½ä»¤äººå›°æƒ‘çš„ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œä¸¤ç§æƒ…å†µä¼šæ‰§è¡Œåˆ°è¿™é‡Œï¼š
                                                                  ; 1. = çš„æƒ…å†µï¼Œé€’å½’åˆ°åº•ï¼Œæ»¡è¶³æ¡ä»¶åç›´æ¥è¿”å› 0
                                                                  ; 2. > çš„æƒ…å†µï¼Œ<+22> è·³è½¬ <+36> åæ‰§è¡Œåˆ°è¿™é‡Œï¼Œä½†æ˜¯æ’ä¸º false ä¼šè·³è¿‡è¿™ä¸€å¥

   0x0000000000400ffb <+45>:	lea    0x1(%rcx),%esi             
   0x0000000000400ffe <+48>:	callq  0x400fce <func4>           ; å¦‚æœå¤§äºç­‰äºï¼Œé€’å½’è°ƒç”¨ func4(x, ++start, res)
   0x0000000000401003 <+53>:	lea    0x1(%rax,%rax,1),%eax      ; åœ¨ä¸Šé¢çš„é€’å½’è°ƒç”¨è¿”å›åæ‰§è¡Œï¼Œæ“ä½œä¸Šé¢è¿™æ¬¡è°ƒç”¨çš„è¿”å›å€¼åå†è¿”å›ç»™ä¸Šå±‚
   0x0000000000401007 <+57>:	add    $0x8,%rsp
   0x000000000040100b <+61>:	retq   
End of assembler dump.
```

åœ¨è§‚å¯Ÿå„ç§å¯„å­˜å™¨æ“ä½œçš„æ—¶å€™åº”è¯¥æƒ³åˆ°ï¼Œæœºå™¨æ‰§è¡Œä¸€ä¸ªæŒ‡ä»¤åªèƒ½åšä¸€ä»¶äº‹ï¼Œæ‰€ä»¥æœ‰å¯èƒ½å¾ˆç®€å•çš„ä¸€å¥ä»£ç ç¿»è¯‘æˆæŒ‡ä»¤éœ€è¦ä¸¤ä¸ªç”šè‡³ä¸‰ä¸ªæŒ‡ä»¤ã€‚

åè¿‡æ¥è¯´ï¼Œå¾ˆå¤šçœ‹ä¸Šå»å¾ˆå¤æ‚ã€å¾ˆå¤šã€æ“ä½œåŒä¸€ä¸ªå¯„å­˜å™¨çš„æŒ‡ä»¤ï¼Œæœ‰å¯èƒ½å¯¹åº”çš„æ˜¯å¾ˆç®€å•çš„ä¸€å¥ä»£ç ã€‚

ç»è¿‡åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°è¿™æ˜¯ä¸€ä¸ªé€’å½’å‡½æ•°ï¼Œæ–¹æ³•ç­¾åå¤§æ¦‚æ˜¯ï¼š`int func4(int x, int start, int end)`ã€‚

å…¶ä¸­ï¼Œstart å’Œ end çš„åˆå§‹å€¼åˆ†åˆ«æ˜¯ 0 å’Œ 14ï¼Œåœ¨æ–¹æ³•å†…éƒ¨å¯¹ç§»ä½ã€å–ç¬¦å·ã€åˆå¹¶ç­‰æ“ä½œï¼Œç›´åˆ°è¿ç®—ç»“æœä¸ x ç›¸åŒæ—¶è¿”å› 0ï¼Œå¦åˆ™å°±å¯¹è¿ç®—ç»“æœ -1 åé€’å½’å‘ä¸‹ã€‚

æ•´ä¸ª `func4` çš„æ‰§è¡Œé€»è¾‘å¤§æ¦‚æ˜¯ï¼š

```c
int func4(int input, int start, int end) {
    // äºŒè€…ç›¸å‡åŠ ä¸Šç»“æœçš„ç¬¦å·ä½åšç®—æœ¯å³ç§» + start
    int sign = (end - start) >> 31;
    int n = (end - start + sign) >>> 1 + start;

    if (input == n) return 0;

    if (input <= n) {
        // å¦‚æœè®¡ç®—çš„ç»“æœæ¯”è¾“å…¥å€¼å¤§ï¼Œä¸Šç•Œ -1 åé€’å½’
        return 2 * func4(input, start, --n);
    } else {
        // å¦‚æœè®¡ç®—çš„ç»“æœæ¯”è¾“å…¥å€¼å°ï¼Œä¸‹ç•Œ +1 åé€’å½’
        int res = 0;
        res = func4(input, ++start, n);
        return 2 * res + 1;
    }
}
```

åœ¨è¿™ä¸ªé—®é¢˜ä¸­ï¼Œè™½ç„¶å°è¯•è¿˜åŸäº† C ä»£ç ï¼Œä½†æ˜¯æ±‡ç¼–ä»£ç å› ä¸ºæœ‰å¾ˆå¤šç¼–è¾‘å™¨çš„ä¼˜åŒ–å¯¼è‡´é€»è¾‘æ³¨é‡Šå¹¶ä¸å¥½å†™æ¸…æ¥šï¼Œè¿˜æ˜¯éœ€è¦ gdb æŸ¥çœ‹æ•´ä¸ªè¿‡ç¨‹ä¼šæ›´æ¸…æ™°ã€‚

åœ¨ä¸Šå±‚è¯­è¨€å¤„ç†é€’å½’é€»è¾‘æ€»æœ‰ç§æ™•æ™•çš„æ„Ÿè§‰ï¼Œä½†å®é™…ä¸Šåœ¨æ±‡ç¼–å±‚ï¼Œé€’å½’ä¹Ÿåªæ˜¯æ™®é€šçš„å‡½æ•°è°ƒç”¨è€Œå·²ï¼Œæ ¹æ®æ¡ä»¶è¿›è¡Œè·³è½¬ã€è°ƒç”¨ã€è¿”å›ï¼Œæ‰€æœ‰çš„æµç¨‹éƒ½å’Œæ™®é€šå‡½æ•°è°ƒç”¨æ˜¯ä¸€æ ·çš„ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±èƒ½æ›´å¥½å¾—æ˜ç™½å’Œç†è§£ï¼š

- é€’å½’è¿‡æ·±ä¼šå› ä¸ºå¤ªå¤šçš„å‡½æ•°è°ƒç”¨å¯¼è‡´æ ˆå¸§è¿‡å¤šï¼Œæœ€ç»ˆå‡ºç°æ ˆæº¢å‡ºé—®é¢˜ï¼›
- å‡½æ•°çš„å°¾è°ƒç”¨ä¼˜åŒ–å¯ä»¥é¿å…æ ˆæº¢å‡ºï¼Œå› ä¸ºå°¾è°ƒç”¨åœºæ™¯ä¸‹æ ¹æœ¬ä¸åˆ›å»ºæ ˆå¸§ï¼Œæ‰€è°“æ— è®ºå¤šæ·±éƒ½ä¸å½±å“æ ˆç©ºé—´ï¼›
- å°¾è°ƒç”¨ä¼˜åŒ–è¿‡çš„å‡½æ•°åªæ˜¯å•çº¯çš„æ“ä½œå¯„å­˜å™¨æ›´æ–°è¿”å›å€¼ï¼Œä¸åªæ˜¯ä¸åˆ›å»ºæ ˆå¸§ï¼Œç”šè‡³ä¸è®¿é—®å†…å­˜ï¼Œæ€§èƒ½ä¹Ÿæ›´å¥½ï¼›

å…·ä½“åœ¨è¿™ä¸ªé—®é¢˜ä¸­ï¼Œæˆ‘ä»¬ä¼šå‘ç°ç¨‹åºä¼šæ ¹æ®è®¡ç®—ç»“æœä¸è¾“å…¥å€¼çš„å¤§å°å¯¹æ¯”ï¼Œä¸åœçš„è°ƒæ•´ä¸Šä¸‹ç•Œé™ï¼Œç›´åˆ°è¾“å…¥å€¼ä¸è®¡ç®—å€¼å®Œå…¨ç›¸ç­‰æ‰è¿”å›ã€‚

åŒæ—¶ï¼Œé€šè¿‡å¯¹ return è¿›è¡Œè¿ç®—æ“ä½œï¼Œä¿è¯åªæœ‰ input çš„å€¼æ˜¯ 0 çš„æ—¶å€™è¿”å›å€¼æ‰æ˜¯ 0ï¼Œå¦åˆ™ä¸€å®šæ˜¯æ­£æ•°ã€‚

ç¬¬å››ä¸ªç‚¸å¼¹æ‹†é™¤å®Œæˆã€‚ğŸ‰

### ç¬¬äº”é˜¶æ®µ

ä½è¿ç®— & æ©ç ã€æ•°ç»„ç´¢å¼•ã€å†…å­˜å¯»å€ã€‚

### ç¬¬å…­é˜¶æ®µ

é“¾è¡¨æ“ä½œã€æ’åºï¼Œå¯èƒ½éœ€è¦è¿˜åŸä¸€ä¸ªé“¾è¡¨ç»“æ„ã€‚

### éšè—é˜¶æ®µ

ç•¥ã€‚

### å†™åœ¨æœ€å

åšå®Œå‰å››ä¸ªé˜¶æ®µï¼Œå¯¹æ±‡ç¼–ä»£ç çš„é˜…è¯»å’Œ gdb çš„ä½¿ç”¨éƒ½å·²ç»æœ‰äº†åŸºæœ¬çš„æŒæ¡ã€‚

`phase_5` å’Œ `phase_6` éš¾åº¦å¢å¤§ï¼Œæˆ‘ç›¸ä¿¡è‡ªå·±ä¹Ÿèƒ½è§£å†³ï¼Œåªæ˜¯ä¼šæŠ•å…¥æ›´å¤šçš„æ—¶é—´ï¼Œä½†æ˜¯æ ¸å¿ƒçš„è®­ç»ƒç›®æ ‡æ˜¯ä¸€æ ·çš„ï¼Œè¾¹é™…æ•ˆåº”é€’å‡ã€‚

æ€è€ƒå†ä¸‰åå†³å®šæˆ˜ç•¥æ€§æ”¾å¼ƒï¼ŒæŠŠæ—¶é—´æŠ•å…¥åˆ°åé¢æ›´é‡è¦çš„å†…å®¹ï¼Œä»¥åæœ‰æ—¶é—´å¯ä»¥å†å›æ¥è§£è°œã€‚

